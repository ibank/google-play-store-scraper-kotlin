name: Publish to Maven Central

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Import GPG key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        echo "$GPG_PRIVATE_KEY" | base64 -d > private.key
        gpg --batch --import private.key
        rm private.key

    - name: Build and test
      run: ./gradlew build test --no-daemon --stacktrace

    - name: Publish to Maven Central (Central Portal)
      env:
        CENTRAL_PORTAL_USERNAME: ${{ secrets.CENTRAL_PORTAL_USERNAME }}
        CENTRAL_PORTAL_PASSWORD: ${{ secrets.CENTRAL_PORTAL_PASSWORD }}
        SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
        SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
      run: |
        ./gradlew publishAllPublicationsToCentralPortalRepository \
          --no-daemon \
          --stacktrace \
          -Psigning.keyId=$SIGNING_KEY_ID \
          -Psigning.password=$SIGNING_PASSWORD \
          -Psigning.secretKeyRingFile=$HOME/.gnupg/secring.gpg

    - name: Publish to GitHub Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        ./gradlew publishAllPublicationsToGitHubPackagesRepository \
          --no-daemon \
          --stacktrace

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: build/libs/

    - name: Create Release Notes
      run: |
        echo "## Published to Maven Central" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Group ID:** com.modern.playscraper" >> $GITHUB_STEP_SUMMARY
        echo "**Artifact ID:** play-store-scraper" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${GITHUB_REF_NAME}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Gradle" >> $GITHUB_STEP_SUMMARY
        echo '```gradle' >> $GITHUB_STEP_SUMMARY
        echo "implementation(\"com.modern.playscraper:play-store-scraper:${GITHUB_REF_NAME}\")" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Maven" >> $GITHUB_STEP_SUMMARY
        echo '```xml' >> $GITHUB_STEP_SUMMARY
        echo "<dependency>" >> $GITHUB_STEP_SUMMARY
        echo "  <groupId>com.modern.playscraper</groupId>" >> $GITHUB_STEP_SUMMARY
        echo "  <artifactId>play-store-scraper</artifactId>" >> $GITHUB_STEP_SUMMARY
        echo "  <version>${GITHUB_REF_NAME}</version>" >> $GITHUB_STEP_SUMMARY
        echo "</dependency>" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
